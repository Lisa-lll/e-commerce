# 用户下单入口说明

## 📍 下单入口

用户可以通过以下方式进入下单流程：

### 1. 从购物车下单（推荐）

**入口位置**：
- 购物车页面：http://localhost:5173/cart

**操作流程**：
1. 用户在商品详情页点击"加入购物车"
2. 商品添加到 localStorage 购物车（未登录用户）或数据库购物车（登录用户）
3. 进入购物车页面查看已选商品
4. 点击"去结算"按钮
5. 跳转到订单创建页面：`/order/create`

**代码位置**：
- 购物车页面：`frontend/src/pages/Cart.tsx`
- 路由：`/cart`

### 2. 从商品详情页直接购买

**入口位置**：
- 商品详情页：http://localhost:5173/products/{id}

**操作流程**：
1. 用户在商品详情页选择数量
2. 点击"立即购买"按钮
3. 商品自动添加到购物车（localStorage）
4. 直接跳转到订单创建页面：`/order/create`

**代码位置**：
- 商品详情页：`frontend/src/pages/ProductDetail.tsx`
- 路由：`/products/:id`

### 3. 直接访问订单创建页面

**入口位置**：
- 订单创建页面：http://localhost:5173/order/create

**注意**：
- 如果购物车为空，会自动跳转回首页
- 需要先添加商品到购物车

## 🔄 下单流程

### 完整流程

```
1. 浏览商品
   ↓
2. 添加商品到购物车（或直接购买）
   ↓
3. 进入订单创建页面 (/order/create)
   ↓
4. 填写收货信息
   - 收货人姓名（必填）
   - 收货人电话（必填，手机号格式验证）
   - 收货地址（必填）
   - 备注（选填）
   ↓
5. 确认订单商品和金额
   ↓
6. 点击"提交订单"
   ↓
7. 调用后端 API 创建订单
   ↓
8. 订单创建成功
   - 清空购物车
   - 跳转到订单查询页面
   - 显示订单号和订单详情
```

## 📋 订单创建页面功能

### 页面组件
- **文件位置**：`frontend/src/pages/OrderCreate.tsx`
- **路由路径**：`/order/create`

### 功能特性

1. **收货信息表单**
   - 收货人姓名（必填）
   - 收货人电话（必填，手机号格式验证：1[3-9]xxxxxxxxx）
   - 收货地址（必填，多行文本）
   - 备注（选填）

2. **订单商品展示**
   - 显示购物车中的所有商品
   - 显示商品图片、名称、单价、数量
   - 自动计算小计和总金额

3. **订单提交**
   - 表单验证（必填项、手机号格式）
   - 提交时显示加载状态
   - 成功后清空购物车
   - 跳转到订单查询页面

### 支持未登录用户

✅ **无需登录即可下单**
- 订单表 `user_id` 字段可为空
- 使用 localStorage 购物车
- 通过订单号+手机号查询订单

## 🔌 API 接口

### 创建订单 API

**接口地址**：`POST /api/v1/orders/orders/`

**请求参数**：
```json
{
  "receiver_name": "张三",
  "receiver_phone": "13800138000",
  "receiver_address": "北京市朝阳区xxx街道xxx号",
  "remark": "请尽快发货",
  "items": [
    {
      "product_id": 1,
      "quantity": 2
    },
    {
      "product_id": 2,
      "quantity": 1
    }
  ]
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "订单创建成功",
  "data": {
    "id": 1,
    "order_no": "ORD202601131234567890",
    "status": 1,
    "status_display": "待付款",
    "total_amount": "299.00",
    "freight_amount": "0.00",
    "pay_amount": "299.00",
    "receiver_name": "张三",
    "receiver_phone": "13800138000",
    "receiver_address": "北京市朝阳区xxx街道xxx号",
    "items": [...],
    "created_at": "2026-01-13T10:30:00Z"
  }
}
```

**代码位置**：
- 前端 API：`frontend/src/api/orders.ts`
- 后端视图：`backend/orders/views.py` - `OrderViewSet.create()`

## 🛒 购物车管理

### localStorage 购物车（未登录用户）

**工具函数**：`frontend/src/utils/cart.ts`

**主要功能**：
- `getLocalCart()` - 获取购物车
- `addToLocalCart()` - 添加商品
- `updateLocalCartItem()` - 更新数量
- `removeLocalCartItem()` - 删除商品
- `clearLocalCart()` - 清空购物车
- `getLocalCartTotal()` - 计算总金额

**存储格式**：
```json
[
  {
    "product_id": 1,
    "product_name": "商品名称",
    "product_image": "http://...",
    "price": "99.00",
    "quantity": 2
  }
]
```

### 数据库购物车（登录用户）

**API 接口**：`/api/v1/orders/cart/`

**功能**：
- 登录用户的购物车存储在数据库
- 支持多设备同步
- 下单后自动清空

## 📱 页面路由

### 相关路由配置

**文件位置**：`frontend/src/App.tsx`

```tsx
<Route path="/cart" element={<Cart />} />
<Route path="/order/create" element={<OrderCreate />} />
<Route path="/order/query" element={<OrderQuery />} />
<Route path="/products/:id" element={<ProductDetail />} />
```

## 🎯 使用示例

### 场景 1：从购物车下单

1. 访问首页：http://localhost:5173
2. 点击商品进入详情页
3. 点击"加入购物车"
4. 点击页面上的"购物车"链接（如果有导航栏）
5. 或直接访问：http://localhost:5173/cart
6. 在购物车页面点击"去结算"
7. 填写收货信息并提交订单

### 场景 2：直接购买

1. 访问商品详情页：http://localhost:5173/products/1
2. 选择数量
3. 点击"立即购买"
4. 直接进入订单创建页面
5. 填写收货信息并提交订单

### 场景 3：查询订单

1. 订单创建成功后自动跳转到：http://localhost:5173/order/query?order_no=ORD...
2. 或手动访问：http://localhost:5173/order/query
3. 输入订单号和手机号查询订单

## ⚠️ 注意事项

1. **购物车验证**
   - 如果购物车为空，会自动跳转回首页
   - 订单创建页面会检查购物车是否有商品

2. **库存检查**
   - 后端会检查商品库存
   - 如果库存不足，会返回错误信息

3. **订单号生成**
   - 格式：`ORD + 年月日时分秒 + 4位随机数`
   - 例如：`ORD202601131234567890`

4. **订单状态**
   - 创建后默认为"待付款"状态（status=1）
   - 管理员可以在后台修改订单状态

5. **未登录用户**
   - 无需注册登录即可下单
   - 订单查询需要订单号和手机号
   - 建议保存订单号以便后续查询

## 🔗 相关文件

### 前端文件
- `frontend/src/pages/OrderCreate.tsx` - 订单创建页面
- `frontend/src/pages/Cart.tsx` - 购物车页面
- `frontend/src/pages/ProductDetail.tsx` - 商品详情页
- `frontend/src/api/orders.ts` - 订单 API
- `frontend/src/utils/cart.ts` - 购物车工具函数

### 后端文件
- `backend/orders/views.py` - 订单视图
- `backend/orders/serializers.py` - 订单序列化器
- `backend/orders/models.py` - 订单模型
- `backend/orders/urls.py` - 订单路由

## ✨ 功能特点

- ✅ 支持未登录用户下单
- ✅ 购物车使用 localStorage（未登录）或数据库（登录）
- ✅ 表单验证（必填项、手机号格式）
- ✅ 自动计算订单金额
- ✅ 订单创建后自动清空购物车
- ✅ 自动跳转到订单查询页面
- ✅ 显示订单号和订单详情
